// $SCHEMANAMESQL$.$TABLENAME$.cs

// This file is automatically generated. Please don't change!

using Arena.Common.Data;
using Arena.Common.Errors;
using Arena.Common.JSON;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Text;

namespace $NAMESPACE$
{
    public partial class $CLASSNAME$
    {
        #region Private Fields

        public static string _tableName = "$SCHEMANAMESQL$.$TABLENAMESQL$";

        private static string _baseQuery = "SELECT * FROM $SCHEMANAMESQL$.$TABLENAMESQL$";
        private static string _firstConj = "WHERE";

        private static string _fieldList;
        private static string _fieldListInsert;

        // specific properties
$ORDDEFS$

        #endregion

        #region Public Properties

        // specific properties
$PROPERTIES$

        #endregion

        #region Constructors

        static $CLASSNAME$()
        {
            // get list of fields for queries
            _fieldList = GetFieldList();
            // get list of fields for inserts
            _fieldListInsert = GetInsertFieldList();
            // make ordinal positions match field list positions
            SetOrdinals();
            // update base query with exact field names
            _baseQuery = _baseQuery.Replace("*", _fieldList);
            // fix base query as needed
            FixBaseQuery();
        }

        #endregion

        #region Partial Method Declarations

        static partial void FixBaseQuery();

        #endregion

        #region ToString

        public JObject ToJson()
        {
            JObject myData = new JObject()
            {
$TOSTRINGFIELDS$
            };
            return myData;
        }

        public override string ToString()
        {
            return ToJson().ToString();
        }

        #endregion

        #region Get Routines

        public static $CLASSNAME$ Get(DataPlug dp, string subQuery)
        {
            if (dp == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: dp"));
            }
            if (string.IsNullOrEmpty(subQuery))
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: subQuery"));
            }
            $CLASSNAME$ result = null;
            try
            {
                using (SqlConnection dc = SQL.GetDataConnection(dp))
                {
                    dc.Open();
                    string query = $"{_baseQuery} {_firstConj} {subQuery};";
                    SqlCommand cmd = new SqlCommand(query, dc)
                    {
                        CommandType = CommandType.Text,
                        CommandTimeout = SQL.SQLTimeoutSeconds
                    };
                    using (SqlDataReader dr = cmd.ExecuteReader(CommandBehavior.SingleRow))
                    {
                        if (dr.Read())
                        {
                            result = new $CLASSNAME$();
                            FillFields(result, dr);
                        }
                    }
                }
            }
            catch (SqlException ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"SQL Exception {ex.Number} during Get: {ex.Message}"));
            }
            catch (Exception ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"Error during Get: {ex.Message}"));
            }
            return result;
        }

        public static List<$CLASSNAME$> GetList(DataPlug dp)
        {
            return GetList(dp, null, null);
        }

        public static List<$CLASSNAME$> GetList(DataPlug dp, string subQuery)
        {
            return GetList(dp, subQuery, null);
        }

        public static List<$CLASSNAME$> GetList(DataPlug dp, string subQuery, string orderBy)
        {
            if (dp == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: dp"));
            }
            List<$CLASSNAME$> result = new List<$CLASSNAME$>();
            $CLASSNAME$ obj;
            try
            {
                using (SqlConnection dc = SQL.GetDataConnection(dp))
                {
                    dc.Open();
                    string query;
                    if (string.IsNullOrEmpty(subQuery) && string.IsNullOrEmpty(orderBy))
                    {
                        query = _baseQuery;
                    }
                    else if (string.IsNullOrEmpty(subQuery))
                    {
                        query = $"{_baseQuery} ORDER BY {orderBy}";
                    }
                    else if (string.IsNullOrEmpty(orderBy))
                    {
                        query = $"{_baseQuery} {_firstConj} {subQuery}";
                    }
                    else
                    {
                        query = $"{_baseQuery} {_firstConj} {subQuery} ORDER BY {orderBy}";
                    }
                    SqlCommand cmd = new SqlCommand(query, dc)
                    {
                        CommandType = CommandType.Text,
                        CommandTimeout = SQL.SQLTimeoutSeconds
                    };
                    using (SqlDataReader dr = cmd.ExecuteReader(CommandBehavior.SingleResult))
                    {
                        while (dr.Read())
                        {
                            obj = new $CLASSNAME$();
                            FillFields(obj, dr);
                            result.Add(obj);
                        }
                    }
                }
            }
            catch (SqlException ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"SQL Exception {ex.Number} during GetList: {ex.Message}"));
            }
            catch (Exception ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"Error during GetList: {ex.Message}"));
            }
            return result;
        }

        public static void Reload(DataPlug dp, $CLASSNAME$ obj)
        {
            if (dp == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: dp"));
            }
            if (obj == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: obj"));
            }
            if (!obj.$IDENTITY$.HasValue)
            {
                throw new SystemException(ErrorHandler.FixMessage("New record cannot be reloaded"));
            }
            try
            {
                using (SqlConnection dc = SQL.GetDataConnection(dp))
                {
                    dc.Open();
                    string query = $"{_baseQuery} {_firstConj} [$IDENTITY$] = {obj.$IDENTITY$};";
                    SqlCommand cmd = new SqlCommand(query, dc)
                    {
                        CommandType = CommandType.Text,
                        CommandTimeout = SQL.SQLTimeoutSeconds
                    };
                    using (SqlDataReader dr = cmd.ExecuteReader(CommandBehavior.SingleRow))
                    {
                        if (dr.Read())
                        {
                            // fill same object
                            FillFields(obj, dr);
                        }
                        else
                        {
                            throw new SystemException(ErrorHandler.FixMessage($"Record not found during Reload: $IDENTITY$ = {obj.$IDENTITY$}"));
                        }
                    }
                }
            }
            catch (SqlException ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"SQL Exception {ex.Number} during Reload: {ex.Message}"));
            }
            catch (Exception ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"Error during Reload: {ex.Message}"));
            }
        }

        #endregion

        #region Add Routines

        public static void Add(DataPlug dp, $CLASSNAME$ obj)
        {
            if (dp == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: dp"));
            }
            if (obj == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: obj"));
            }
            if (obj.$IDENTITY$.HasValue)
            {
                throw new SystemException(ErrorHandler.FixMessage("Existing record cannot be added"));
            }
            StringBuilder sb = new StringBuilder();
            sb.Append("INSERT INTO ");
            sb.Append(_tableName);
            sb.Append(" (");
            sb.Append(_fieldListInsert);
            sb.Append(") VALUES (");
            sb.Append(GetInsertValueList(obj));
            sb.Append("); SELECT SCOPE_IDENTITY();");
            try
            {
                using (SqlConnection dc = SQL.GetDataConnection(dp))
                {
                    dc.Open();
                    SqlCommand cmd = new SqlCommand(sb.ToString(), dc)
                    {
                        CommandType = CommandType.Text,
                        CommandTimeout = SQL.SQLTimeoutSeconds
                    };
                    using (SqlDataReader dr = cmd.ExecuteReader(CommandBehavior.SingleRow))
                    {
                        if (dr.Read())
                        {
                            obj.$IDENTITY$ = (int)dr.GetDecimal(0); // SCOPE_IDENTITY()
                        }
                        else
                        {
                            throw new SystemException(ErrorHandler.FixMessage("No rows inserted during Add"));
                        }
                    }
                }
            }
            catch (SqlException ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"SQL Exception {ex.Number} during Add: {ex.Message}"));
            }
            catch (Exception ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"Error during Add: {ex.Message}"));
            }
        }

        public static void AddWithReload(DataPlug dp, $CLASSNAME$ obj)
        {
            Add(dp, obj);
            Reload(dp, obj);
        }

        #endregion

        #region Update Routines

        public static void Update(DataPlug dp, $CLASSNAME$ obj)
        {
            if (dp == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: dp"));
            }
            if (obj == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: obj"));
            }
            if (!obj.$IDENTITY$.HasValue)
            {
                throw new SystemException(ErrorHandler.FixMessage("New record cannot be updated"));
            }
            StringBuilder sb = new StringBuilder();
            sb.Append("UPDATE ");
            sb.Append(_tableName);
            sb.Append(" SET ");
            sb.Append(GetUpdateValueList(obj));
            sb.Append(" WHERE [$IDENTITY$] = ");
            sb.Append(obj.$IDENTITY$);
            sb.Append(";");
            try
            {
                using (SqlConnection dc = SQL.GetDataConnection(dp))
                {
                    dc.Open();
                    SqlCommand cmd = new SqlCommand(sb.ToString(), dc)
                    {
                        CommandType = CommandType.Text,
                        CommandTimeout = SQL.SQLTimeoutSeconds
                    };
                    int rowsChanged = cmd.ExecuteNonQuery();
                    if (rowsChanged == 0)
                    {
                        throw new SystemException(ErrorHandler.FixMessage($"No rows changed during Update: $IDENTITY$ = {obj.$IDENTITY$}"));
                    }
                }
            }
            catch (SqlException ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"SQL Exception {ex.Number} during Update: {ex.Message}"));
            }
            catch (Exception ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"Error during Update: {ex.Message}"));
            }
        }

        public static void UpdateWithReload(DataPlug dp, $CLASSNAME$ obj)
        {
            Update(dp, obj);
            Reload(dp, obj);
        }

        #endregion

        #region Delete Routines

        public static void Delete(DataPlug dp, ref $CLASSNAME$ obj)
        {
            if (dp == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: dp"));
            }
            if (obj == null)
            {
                throw new SystemException(ErrorHandler.FixMessage("Argument is null: obj"));
            }
            if (!obj.$IDENTITY$.HasValue)
            {
                throw new SystemException(ErrorHandler.FixMessage("New record cannot be deleted"));
            }
            StringBuilder sb = new StringBuilder();
            sb.Append("DELETE FROM ");
            sb.Append(_tableName);
            sb.Append(" WHERE [$IDENTITY$] = ");
            sb.Append(obj.$IDENTITY$);
            sb.Append(";");
            try
            {
                using (SqlConnection dc = SQL.GetDataConnection(dp))
                {
                    dc.Open();
                    SqlCommand cmd = new SqlCommand(sb.ToString(), dc)
                    {
                        CommandType = CommandType.Text,
                        CommandTimeout = SQL.SQLTimeoutSeconds
                    };
                    int rowsChanged = cmd.ExecuteNonQuery();
                    if (rowsChanged == 0)
                    {
                        throw new SystemException(ErrorHandler.FixMessage($"No rows changed during Delete: $IDENTITY$ = {obj.$IDENTITY$}"));
                    }
                }
                obj = null; // no longer exists
            }
            catch (SqlException ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"SQL Exception {ex.Number} during Delete: {ex.Message}"));
            }
            catch (Exception ex)
            {
                throw new SystemException(ErrorHandler.FixMessage($"Error during Delete: {ex.Message}"));
            }
        }

        #endregion

        #region Private Routines

        private static string GetFieldList()
        {
            // get list of all fields for queries
            StringBuilder sb = new StringBuilder();
$GETFIELDLIST$
            return sb.ToString();
        }

        private static string GetInsertFieldList()
        {
            // get list of fields for updates
            StringBuilder sb = new StringBuilder();
$GETINSERTFIELDLIST$
            return sb.ToString();
        }

        private static string GetInsertValueList($CLASSNAME$ obj)
        {
            // create list of values for updates
            StringBuilder sb = new StringBuilder();
$GETINSERTVALUELIST$
            return sb.ToString();
        }

        private static string GetUpdateValueList($CLASSNAME$ obj)
        {
            // create list of values for updates
            StringBuilder sb = new StringBuilder();
$GETUPDATEVALUELIST$
            return sb.ToString();
        }

        private static void SetOrdinals()
        {
            // make ordinal positions match field list positions
$SETORDINALS$
        }

        private static void FillFields($CLASSNAME$ obj, SqlDataReader dr)
        {
            // fill object from data reader
$FILLFIELDS$
        }

        #endregion

    }
}
